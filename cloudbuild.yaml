steps:
  - name: openjdk:11
    id: test
    entrypoint: "./gradlew"
    args: [ "check" ]
    volumes:
      - name: user.home
        path: /userhome
  - name: openjdk:11
    id: build-image
    entrypoint: "/bin/bash"
    args:
      - '-eEuo'
      - 'pipefail'
      - '-c'
      - |-
        export USER_HOME="/userhome"

        M2_HOME="${HOME}/.m2"
        M2_CACHE="${USER_HOME}/maven"
        GRADLE_HOME="${HOME}/.gradle"
        GRADLE_CACHE="${USER_HOME}/gradle"

        echo "Generating symbolic links for caches"

        [[ -d "${M2_CACHE}" && ! -d "${M2_HOME}" ]] && ln -s "${M2_CACHE}" "${M2_HOME}"
        [[ -d "${GRADLE_CACHE}" && ! -d "${GRADLE_HOME}" ]] && ln -s "${GRADLE_CACHE}" "${GRADLE_HOME}"
        ./gradlew jib --image=gcr.io/$PROJECT_ID/hello-cloud-build:$SHORT_SHA
    volumes:
      - name: user.home
        path: /userhome

  - name: 'gcr.io/cloud-builders/gcloud'
    args: [ 'run', 'deploy', "--image=gcr.io/$PROJECT_ID/hello-cloud-build:$SHORT_SHA", '--platform=managed', '--project=$PROJECT_ID', '--region=us-central1', '--allow-unauthenticated', '--memory=256Mi', '--set-env-vars=SPRING_PROFILES_ACTIVE=gcp', 'hello-cloud-build' ]
    volumes:
      - name: user.home
        path: /userhome
